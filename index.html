<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Laporan Keuangan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Export Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- Export PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body class="bg-gray-100 p-6">

<h1 class="text-2xl font-bold mb-6">ðŸ“Š Laporan Keuangan</h1>

<!-- ================= DASHBOARD ================= -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <div class="bg-green-100 p-4 rounded shadow">
    <p class="text-sm">Pemasukan</p>
    <h2 id="pemasukan" class="text-xl font-bold">Rp 0</h2>
  </div>
  <div class="bg-red-100 p-4 rounded shadow">
    <p class="text-sm">Pengeluaran</p>
    <h2 id="pengeluaran" class="text-xl font-bold">Rp 0</h2>
  </div>
  <div class="bg-blue-100 p-4 rounded shadow">
    <p class="text-sm">Saldo</p>
    <h2 id="saldo" class="text-xl font-bold">Rp 0</h2>
  </div>
</div>

<!-- ================= FORM ================= -->
<form id="formTransaksi"
  class="grid grid-cols-1 md:grid-cols-7 gap-3 bg-white p-4 rounded shadow mb-6">

  <input type="date" id="tanggal" required class="border p-2 rounded" />
  <input type="text" id="catatan" placeholder="Catatan" class="border p-2 rounded" />

  <select id="jenis" class="border p-2 rounded" required>
    <option value="pemasukan">Pemasukan</option>
    <option value="pengeluaran">Pengeluaran</option>
  </select>

  <!-- KATEGORI (DINAMIS) -->
  <select id="kategori" class="border p-2 rounded" required></select>

  <input type="number" id="nominal" placeholder="Nominal" class="border p-2 rounded" required />
  <input type="number" id="qty" value="1" min="1" class="border p-2 rounded" required />

  <button id="btnSubmit"
    class="md:col-span-7 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">
    Simpan
  </button>
</form>

<!-- ================= FILTER & EXPORT ================= -->
<div class="flex flex-wrap gap-2 mb-4">
  <input type="month" id="filterBulan" class="border p-2 rounded" />

  <button id="btnFilter" class="bg-blue-600 text-white px-4 rounded">
    Filter
  </button>

  <button id="btnReset" class="bg-gray-500 text-white px-4 rounded">
    Reset
  </button>

  <button onclick="exportExcel()" class="bg-green-600 text-white px-4 rounded">
    Excel
  </button>

  <button onclick="exportPDF()" class="bg-red-600 text-white px-4 rounded">
    PDF
  </button>
</div>

<!-- ================= TABLE ================= -->
<div class="bg-white rounded shadow overflow-x-auto">
<table class="min-w-full text-sm">
  <thead class="bg-gray-200">
    <tr>
      <th class="p-2 text-left">Tanggal</th>
      <th class="p-2 text-left">Catatan</th>
      <th class="p-2">Jenis</th>
      <th class="p-2">Kategori</th>
      <th class="p-2 text-right">Nominal</th>
      <th class="p-2 text-right">Qty</th>
      <th class="p-2 text-right">Total</th>
      <th class="p-2">Aksi</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>
</div>

<!-- ================= REKAP ================= -->
<div id="rekapKategori" class="bg-white p-4 mt-6 rounded shadow"></div>

<!-- ================= SCRIPT ================= -->
<script type="module">
import {
  getTransaksi,
  getTransaksiByBulan,
  addTransaksi,
  updateTransaksi,
  deleteTransaksi
} from './js/transaksi.js';

/* ================= KATEGORI ================= */
const KATEGORI_LIST = [
  'Marketing dan promosi',
  'Jasa photography',
  'Cetak media promosi',
  'Event',
  'Bazzar dan pameran',
  'Kemasan',
  'Beban angkut penjualan',
  'Labeling',
  'Visual Merchandise',
  'Sponsorship',
  'Survey',
  'Gaji dan kesejahteraan karyawan',
  'Pengembangan Karyawan',
  'Seragam Karyawan',
  'Listrik air dan telepon',
  'Sewa',
  'Perlengkapan dan peralatan kantor',
  'Transportasi',
  'Paket dan ekspedisi',
  'Perjalanan Dinas',
  'Beban reparasi dan pemeliharaan aset tetap',
  'Pajak dan retribusi',
  'Relasi, customer dan VIP',
  'Konsolidasi',
  'Umum',
  'Iuran',
  'Sumbangan',
  'CSR',
  'Jasa konsultasi',
  'Inovasi',
  'Asuransi',
  'Administrasi',
  'Other',
  'Pembelian Aset',
  'Cicilan Aset',
  'Cicilan Bank',
  'Piutang Karyawan',
  'Piutang Boko',
  'Piutang Jiwa Jogja',
  'Piutang Cafe'
];

const kategoriSelect = document.getElementById('kategori');
function loadKategori() {
  kategoriSelect.innerHTML = '<option value="">-- Pilih Kategori --</option>';
  KATEGORI_LIST.forEach(k => {
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = k;
    kategoriSelect.appendChild(opt);
  });
}
loadKategori();

/* ================= ELEMENT ================= */
const tbody = document.getElementById('tbody');
const pemasukanEl = document.getElementById('pemasukan');
const pengeluaranEl = document.getElementById('pengeluaran');
const saldoEl = document.getElementById('saldo');
const btnSubmit = document.getElementById('btnSubmit');

let editId = null;

/* ================= LOAD ================= */
async function loadData() {
  const { data } = await getTransaksi();
  renderTable(data);
  renderRekap(data);
}

/* ================= RENDER ================= */
function renderTable(data) {
  let pemasukan = 0;
  let pengeluaran = 0;
  tbody.innerHTML = '';

  data.forEach(item => {
    if (item.jenis === 'pemasukan') pemasukan += item.total;
    else pengeluaran += item.total;

    tbody.innerHTML += `
      <tr class="border-t">
        <td class="p-2">${item.tanggal}</td>
        <td class="p-2">${item.catatan ?? ''}</td>
        <td class="p-2 text-center">${item.jenis}</td>
        <td class="p-2">${item.kategori}</td>
        <td class="p-2 text-right">Rp ${item.nominal.toLocaleString()}</td>
        <td class="p-2 text-right">${item.qty}</td>
        <td class="p-2 text-right font-semibold">Rp ${item.total.toLocaleString()}</td>
        <td class="p-2 text-center">
          <button onclick='editTransaksi(${JSON.stringify(item)})'
            class="text-blue-600">Edit</button>
          |
          <button onclick="hapus('${item.id}')"
            class="text-red-600">Hapus</button>
        </td>
      </tr>`;
  });

  pemasukanEl.textContent = 'Rp ' + pemasukan.toLocaleString();
  pengeluaranEl.textContent = 'Rp ' + pengeluaran.toLocaleString();
  saldoEl.textContent = 'Rp ' + (pemasukan - pengeluaran).toLocaleString();
}

/* ================= REKAP ================= */
function renderRekap(data) {
  const rekap = {};
  data.forEach(i => {
    rekap[i.kategori] = (rekap[i.kategori] || 0) + i.total;
  });

  const el = document.getElementById('rekapKategori');
  el.innerHTML = '<h3 class="font-bold mb-2">Rekap per Kategori</h3>';

  for (const k in rekap) {
    el.innerHTML += `
      <div class="flex justify-between border-b py-1">
        <span>${k}</span>
        <span>Rp ${rekap[k].toLocaleString()}</span>
      </div>`;
  }
}

/* ================= ACTION ================= */
window.hapus = async (id) => {
  await deleteTransaksi(id);
  loadData();
};

window.editTransaksi = (item) => {
  editId = item.id;
  tanggal.value = item.tanggal;
  catatan.value = item.catatan ?? '';
  jenis.value = item.jenis;
  kategori.value = item.kategori;
  nominal.value = item.nominal;
  qty.value = item.qty;
  btnSubmit.textContent = 'Update';
};

formTransaksi.onsubmit = async (e) => {
  e.preventDefault();

  const payload = {
    tanggal: tanggal.value,
    catatan: catatan.value,
    jenis: jenis.value,
    kategori: kategori.value,
    nominal: Number(nominal.value),
    qty: Number(qty.value)
  };

  if (editId) {
    await updateTransaksi(editId, payload);
    editId = null;
    btnSubmit.textContent = 'Simpan';
  } else {
    await addTransaksi(payload);
  }

  formTransaksi.reset();
  loadData();
};

/* ================= FILTER ================= */
btnFilter.onclick = async () => {
  if (!filterBulan.value) return;
  const { data } = await getTransaksiByBulan(filterBulan.value);
  renderTable(data);
  renderRekap(data);
};

btnReset.onclick = loadData;

/* ================= EXPORT ================= */
window.exportExcel = () => {
  const wb = XLSX.utils.table_to_book(document.querySelector('table'));
  XLSX.writeFile(wb, 'laporan-keuangan.xlsx');
};

window.exportPDF = () => {
  html2pdf().from(document.body).save('laporan-keuangan.pdf');
};

loadData();
</script>

</body>
</html>
