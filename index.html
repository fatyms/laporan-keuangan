<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Laporan Keuangan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body class="bg-gray-100 p-6">

<h1 class="text-2xl font-bold mb-6">ðŸ“Š Laporan Keuangan</h1>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <div class="bg-green-100 p-4 rounded shadow">
    <p class="text-sm">Pemasukan</p>
    <h2 id="pemasukan" class="text-xl font-bold">Rp 0</h2>
  </div>
  <div class="bg-red-100 p-4 rounded shadow">
    <p class="text-sm">Pengeluaran</p>
    <h2 id="pengeluaran" class="text-xl font-bold">Rp 0</h2>
  </div>
  <div class="bg-blue-100 p-4 rounded shadow">
    <p class="text-sm">Saldo</p>
    <h2 id="saldo" class="text-xl font-bold">Rp 0</h2>
  </div>
</div>

<form id="formTransaksi" class="grid grid-cols-1 md:grid-cols-12 gap-3 bg-white p-4 rounded shadow mb-6">
  <input type="date" id="tanggal" class="border p-2 rounded md:col-span-2" required />
  <input type="text" id="catatan" placeholder="Catatan" class="border p-2 rounded md:col-span-4" />
  
  <select id="jenis" class="border p-2 rounded md:col-span-2" required>
    <option value="pemasukan">Pemasukan</option>
    <option value="pengeluaran">Pengeluaran</option>
  </select>

  <select id="kategori" class="border p-2 rounded md:col-span-2" required></select>

  <input type="number" id="nominal" placeholder="Nominal" class="border p-2 rounded md:col-span-1" required />
  <input type="number" id="qty" placeholder="Qty" value="1" min="1" class="border p-2 rounded md:col-span-1" required />

  <input type="text" id="totalView" placeholder="Total" class="border p-2 rounded md:col-span-2 bg-gray-100 font-semibold" readonly />

  <button id="btnSubmit" type="submit" class="md:col-span-12 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">
    Simpan Transaksi
  </button>
</form>

<div class="bg-white p-4 rounded shadow mb-4">
  <div class="flex flex-wrap gap-4 items-end">
    <div>
      <label class="block text-xs text-gray-500 mb-1">Dari Tanggal</label>
      <input type="date" id="startDate" class="border p-2 rounded w-full">
    </div>
    <div>
      <label class="block text-xs text-gray-500 mb-1">Sampai Tanggal</label>
      <input type="date" id="endDate" class="border p-2 rounded w-full">
    </div>
    <button id="btnFilterTanggal" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">Tampilkan</button>
    <button id="btnReset" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded">Reset</button>
    
    <div class="flex gap-2 ml-auto">
        <button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded">Export Excel</button>
        <button onclick="exportPDF()" class="bg-red-600 text-white px-4 py-2 rounded">Export PDF</button>
    </div>
  </div>
  <p id="infoPeriode" class="text-sm text-blue-600 mt-2 font-medium"></p>
</div>

<div class="bg-white rounded shadow overflow-x-auto">
  <table class="min-w-full text-sm">
    <thead class="bg-gray-200">
      <tr>
        <th class="p-3 text-left">Tanggal</th>
        <th class="p-3 text-left">Catatan</th>
        <th class="p-3 text-center">Jenis</th>
        <th class="p-3 text-left">Kategori</th>
        <th class="p-3 text-right">Nominal</th>
        <th class="p-3 text-center">Qty</th>
        <th class="p-3 text-right">Total</th>
        <th class="p-3 text-center">Aksi</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div id="rekapKategori" class="bg-white p-4 mt-6 rounded shadow"></div>

<script type="module">
import {
  getTransaksi,
  getTransaksiByTanggal,
  addTransaksi,
  updateTransaksi,
  deleteTransaksi
} from './js/transaksi.js';

const KATEGORI_LIST = [
  'Marketing dan promosi', 'Jasa photography', 'Cetak media promosi', 'Event', 'Bazzar dan pameran', 
  'Kemasan', 'Beban angkut penjualan', 'Labeling', 'Visual Merchandise', 'Sponsorship', 
  'Survey', 'Gaji dan kesejahteraan karyawan', 'Pengembangan Karyawan', 'Seragam Karyawan', 
  'Listrik air dan telepon', 'Sewa', 'Perlengkapan dan peralatan kantor', 'Transportasi', 
  'Paket dan ekspedisi', 'Perjalanan Dinas', 'Beban reparasi dan pemeliharaan aset tetap', 
  'Pajak dan retribusi', 'Relasi, customer dan VIP', 'Konsolidasi', 'Umum', 'Iuran', 
  'Sumbangan', 'CSR', 'Jasa konsultasi', 'Inovasi', 'Asuransi', 'Administrasi', 
  'Other', 'Pembelian Aset', 'Cicilan Aset', 'Cicilan Bank', 'Piutang Karyawan', 
  'Piutang Boko', 'Piutang Jiwa Jogja', 'Piutang Cafe', 'Modal'
];

const nominalInput = document.getElementById('nominal');
const qtyInput = document.getElementById('qty');
const totalView = document.getElementById('totalView');
const formTransaksi = document.getElementById('formTransaksi');
const tbody = document.getElementById('tbody');
const infoPeriode = document.getElementById('infoPeriode');
const btnSubmit = document.getElementById('btnSubmit');

let editId = null;

// Hitung Total Otomatis
function hitungTotal() {
  const nominal = Number(nominalInput.value) || 0;
  const qty = Number(qtyInput.value) || 0;
  const total = nominal * qty;
  totalView.value = total ? 'Rp ' + total.toLocaleString('id-ID') : '';
}
nominalInput.addEventListener('input', hitungTotal);
qtyInput.addEventListener('input', hitungTotal);

// Load Kategori
function loadKategori() {
  const kategoriSelect = document.getElementById('kategori');
  kategoriSelect.innerHTML = '<option value="">-- Pilih Kategori --</option>';
  KATEGORI_LIST.sort().forEach(k => {
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = k;
    kategoriSelect.appendChild(opt);
  });
}

// Render Table
function renderTable(data) {
  let pemasukan = 0;
  let pengeluaran = 0;
  tbody.innerHTML = '';

  data.forEach(item => {
    const itemTotal = item.nominal * item.qty;
    if (item.jenis === 'pemasukan') pemasukan += itemTotal;
    else pengeluaran += itemTotal;

    tbody.innerHTML += `
      <tr class="border-t hover:bg-gray-50">
        <td class="p-3">${item.tanggal}</td>
        <td class="p-3">${item.catatan || '-'}</td>
        <td class="p-3 text-center">
            <span class="${item.jenis === 'pemasukan' ? 'text-green-600' : 'text-red-600'} capitalize">
                ${item.jenis}
            </span>
        </td>
        <td class="p-3">${item.kategori}</td>
        <td class="p-3 text-right">Rp ${item.nominal.toLocaleString('id-ID')}</td>
        <td class="p-3 text-center">${item.qty}</td>
        <td class="p-3 text-right font-bold">Rp ${itemTotal.toLocaleString('id-ID')}</td>
        <td class="p-3 text-center">
          <button onclick='editTransaksi(${JSON.stringify(item)})' class="text-blue-600 hover:underline mr-2">Edit</button>
          <button onclick="hapus('${item.id}')" class="text-red-600 hover:underline">Hapus</button>
        </td>
      </tr>`;
  });

  document.getElementById('pemasukan').textContent = 'Rp ' + pemasukan.toLocaleString('id-ID');
  document.getElementById('pengeluaran').textContent = 'Rp ' + pengeluaran.toLocaleString('id-ID');
  document.getElementById('saldo').textContent = 'Rp ' + (pemasukan - pengeluaran).toLocaleString('id-ID');
}

function renderRekap(data) {
  const rekap = {};
  data.forEach(i => {
    const t = i.nominal * i.qty;
    rekap[i.kategori] = (rekap[i.kategori] || 0) + t;
  });

  const el = document.getElementById('rekapKategori');
  el.innerHTML = '<h3 class="font-bold mb-4 text-lg border-b pb-2">Rekap per Kategori</h3>';
  
  Object.keys(rekap).sort().forEach(k => {
    el.innerHTML += `
      <div class="flex justify-between border-b py-2 text-sm">
        <span>${k}</span>
        <span class="font-semibold">Rp ${rekap[k].toLocaleString('id-ID')}</span>
      </div>`;
  });
}

async function loadData() {
  const { data, error } = await getTransaksi();
  if (error) console.error(error);
  else {
    renderTable(data);
    renderRekap(data);
  }
}

// Fungsi untuk membuka modal
window.showModal = (contentHtml) => {
  const modal = document.getElementById('modalOverlay');
  const modalContent = document.getElementById('modalContent');
  modalContent.innerHTML = contentHtml;
  modal.classList.remove('hidden'); // Menampilkan modal
};

// Fungsi untuk menutup modal
window.closeModal = () => {
  const modal = document.getElementById('modalOverlay');
  modal.classList.add('hidden'); // Menyembunyikan modal
};  

// Global Actions
window.editTransaksi = (item) => {
  editId = item.id;

  // Pindahkan form ke dalam variabel string untuk ditampilkan di modal
  // Atau lebih mudah: tampilkan form yang sudah ada di tengah
  const overlay = document.getElementById('modalOverlay');
  const form = document.getElementById('formTransaksi');

  // Memasukkan form ke dalam modal (opsional: atau buat form khusus modal)
  document.getElementById('modalContent').appendChild(form);

  // Isi data ke form
  document.getElementById('tanggal').value = item.tanggal;
  document.getElementById('catatan').value = item.catatan || '';
  document.getElementById('jenis').value = item.jenis;
  document.getElementById('kategori').value = item.kategori;
  document.getElementById('nominal').value = item.nominal;
  document.getElementById('qty').value = item.qty;
  
  hitungTotal();
  btnSubmit.textContent = 'Update Transaksi';
  overlay.classList.remove('hidden');
  // window.scrollTo({ top: 0, behavior: 'smooth' });
};

window.hapus = async (id) => {
  if (!confirm('Hapus transaksi ini?')) return;
  const res = await deleteTransaksi(id);
  if (res.error) alert('Gagal menghapus');
  else loadData();
};

formTransaksi.onsubmit = async (e) => {
  e.preventDefault();
  const payload = {
    tanggal: document.getElementById('tanggal').value,
    catatan: document.getElementById('catatan').value,
    jenis: document.getElementById('jenis').value,
    kategori: document.getElementById('kategori').value,
    nominal: Number(nominalInput.value),
    qty: Number(qtyInput.value)
  };

  let result = editId 
    ? await updateTransaksi(editId, payload) 
    : await addTransaksi(payload);

  if (result.error) {
    alert('Error: ' + result.error.message);
  } else {
    formTransaksi.reset();
    totalView.value = '';
    editId = null;
    btnSubmit.textContent = 'Simpan Transaksi';
    loadData();
  }
};

// Filter Tanggal
document.getElementById('btnFilterTanggal').onclick = async () => {
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;

  if (!start || !end) {
    alert('Harap pilih Tanggal Mulai dan Tanggal Akhir!');
    return;
  }

  // Validasi: Mulai tidak boleh lebih besar dari Akhir
  if (start > end) {
    alert('Tanggal mulai tidak boleh melebihi tanggal akhir.');
    return;
  }
  
  try {
    const { data, error } = await getTransaksiByTanggal(start, end);
    if (error) throw error;

    if (data.length === 0) {
      alert('Tidak ada data pada rentang tanggal tersebut.');
    }

    renderTable(data);
    renderRekap(data);
    document.getElementById('infoPeriode').textContent = `ðŸ“ Menampilkan data: ${start} s/d ${end}`;
  } catch (err) {
    console.error('Filter Error:', err);
    alert('Terjadi kesalahan saat memfilter data.');
  }
};

// Reset Filter
  document.getElementById('btnReset').onclick = () => {
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  document.getElementById('infoPeriode').textContent = '';
  loadData(); // Memanggil ulang semua data dari database
};

// Exports
window.exportExcel = () => {
  const wb = XLSX.utils.table_to_book(document.querySelector('table'));
  XLSX.writeFile(wb, `Laporan_${new Date().getTime()}.xlsx`);
};

window.exportPDF = () => {
  const element = document.body;
  html2pdf().from(element).set({
    margin: 10,
    filename: 'Laporan_Keuangan.pdf',
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
  }).save();
};

// Init
window.addEventListener('load', () => {
  loadKategori();
  loadData();
});
</script>
  <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 relative">
      <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
        âœ•
      </button>
    
      <div id="modalContent">
    </div>
  </div>
</div>
  
</body>
</html>



